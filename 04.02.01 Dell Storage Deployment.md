
# Key Capabilities & Considerations in v2.x

Before diving into deployment steps, here are some features and prerequisites in the v2.x family which will also apply to v2.14.0:

- Dell‚Äôs CSI PowerMax driver is installed via the **Dell CSM Operator** (not via Helm) in newer releases.  
- The driver supports multiple protocols (depending on your setup): **FC, iSCSI, NFS, NVMe/TCP**.  
- The driver includes a **Reverse Proxy component**, which requires TLS secrets and configuration.  
- Logging level is dynamic via a **ConfigMap** (e.g. `powermax-config-params`) for CSI log adjustments.  
- **Volume Health Monitoring** is supported (from v2.2.0 onwards), but in OpenShift clusters some alpha/optional features may be restricted.  
- **Unisphere REST endpoint version requirement**: Starting from some v2.x versions, only **Unisphere 10.0 REST endpoints** are supported. Ensure your storage array‚Äôs Unisphere is compatible.  

---

# üõ† Steps to Deploy CSI PowerMax v2.14.0 in OpenShift

Here‚Äôs a rough step-by-step flow. You may need to adapt to your OpenShift version and environment.

| Step | What You Do |
|------|-------------|
| **1** | **Ensure Prerequisites:** <br>‚Ä¢ Nodes must support the chosen protocol (FC, iSCSI, NVMe/TCP) <br>‚Ä¢ Install multipath / device-mapper-multipath packages if required <br>‚Ä¢ For iSCSI: ensure `iscsid` service is enabled on nodes (via MachineConfig in OpenShift) <br>‚Ä¢ Ensure connectivity from nodes to PowerMax (zoning, IPs, routing) <br>‚Ä¢ TLS certificate / secret for reverse proxy (if used) <br>‚Ä¢ Prepare credentials for Unisphere (username/password) <br>‚Ä¢ Ensure that the CSI driver images (on quay.io or allowed registry) are accessible |
| **2** | **Install or Enable Dell CSM / CSI Operator** <br>Use OperatorHub in OpenShift, or via CLI, to install the CSM / CSI Operator that includes PowerMax support. |
| **3** | **Create Namespace & Secrets** <br>‚Ä¢ Create a namespace (like `powermax`) <br>‚Ä¢ Create a Secret `powermax-creds` containing base64-encoded username and password for the Unisphere API <br>‚Ä¢ If TLS for reverse proxy is required, create `csirevproxy-tls-secret` in that namespace containing `tls.crt` and `tls.key` |
| **4** | **Create or Provide Configuration (ConfigMap / CR)** <br>‚Ä¢ A ConfigMap may list driver parameters (endpoints, managed arrays, port groups, transport protocol, etc.) <br>‚Ä¢ In the driver‚Äôs CR (e.g. `CSIPowerMax`), define parameters: <br>‚ÄÉ ‚Ä¢ `X_CSI_POWERMAX_ENDPOINT` <br>‚ÄÉ ‚Ä¢ `X_CSI_MANAGED_ARRAYS` <br>‚ÄÉ ‚Ä¢ `X_CSI_TRANSPORT_PROTOCOL` (FC, iSCSI, NVMeTCP, etc.) <br>‚ÄÉ ‚Ä¢ Port groups if using iSCSI <br>‚ÄÉ ‚Ä¢ TLS/revproxy parameters <br>‚ÄÉ ‚Ä¢ Volume prefix, monitor interval, etc. <br>‚Ä¢ Ensure mount propagation is allowed |
| **5** | **Deploy the PowerMax CR** <br>Use the custom resource manifest (provided by Dell) to create the PowerMax driver instance. This will spin up controller pods and node plugin pods. |
| **6** | **Verify Pods / Operator** <br>Check in the PowerMax namespace: `oc get pods -n powermax` <br>Ensure no failures or restart loops. <br>Inspect CSI-PowerMax pod logs for errors. |
| **7** | **StorageClass Creation** <br>Dell‚Äôs operator/CR may auto-create StorageClass resources. <br>Edit as needed (reclaimPolicy, volumeBindingMode, allowVolumeExpansion). |
| **8** | **Create PVC / Pod** <br>With the StorageClass in place, create a PVC, then a Pod that mounts it. <br>The CSI driver provisions a LUN/volume on the PowerMax array. |
| **9** | **Testing & Validation** <br>‚Ä¢ Check `oc get pvc`, `oc describe pvc` <br>‚Ä¢ Inside pod, verify mount and read/write <br>‚Ä¢ Test expand & deletion <br>‚Ä¢ Monitor logs & metrics <br>‚Ä¢ Test node failures & reattachment |
| **10** | **Ongoing Operations** <br>‚Ä¢ Adjust logging via ConfigMap <br>‚Ä¢ Monitor health (if enabled) <br>‚Ä¢ Follow Dell‚Äôs documented upgrade path for updates |

---

# Sample Snippet (Illustrative YAML)

## Secret (powermax-creds)

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: powermax-creds
  namespace: powermax
type: Opaque
data:
  username: {{ base64-of-username }}
  password: {{ base64-of-password }}
````

## Custom Resource (CSIPowerMax)

```yaml
apiVersion: csi.dellemc.com/v1
kind: CSIPowerMax
metadata:
  name: powermax
  namespace: powermax
spec:
  csiPluginImage: quay.io/dellemc/csi-powermax:v2.14.0
  reverseProxy:
    enable: true
    tlsSecret: csirevproxy-tls-secret
    port: 2222
  storage:
    protocol: iSCSI       # or ‚ÄúFC‚Äù, ‚ÄúNVMeTCP‚Äù
    portGroups: "PG1,PG2"
  unisphere:
    endpoint: "https://unisphere.example.com:8443"
    managedArrays: "000197800123"
  node:
    logLevel: "info"
  controller:
    logLevel: "info"
    volumePrefix: "pmax"
    monitorInterval: "60s"
```

---

# Common Pitfalls / Gotchas

* **Mixing Protocols**: Cannot use FC and iSCSI simultaneously in one driver instance.
* **Unisphere Version Compatibility**: Newer drivers may require Unisphere 10.x only.
* **Mount Propagation & Device Mounts**: Ensure runtime allows CSI mount propagation.
* **Reverse Proxy TLS Setup**: Incorrect setup causes node/controller communication failures.
* **Logging & Debugging**: Use the ConfigMap for dynamic log level adjustments.
* **Volume Expansion / Health Monitoring**: May be disabled by default in OpenShift.
* **Permissions & RBAC**: Ensure the operator has correct roles.
* **Node Connectivity**: Multipath and zoning must be correct.
* **Upgrades**: Always follow Dell‚Äôs documented upgrade path.

---

# Example Manifest for CSI PowerMax v2.14.0

```yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: powermax

---
apiVersion: v1
kind: Secret
metadata:
  name: powermax-creds
  namespace: powermax
type: Opaque
data:
  username: <BASE64_ENCODED_USERNAME>
  password: <BASE64_ENCODED_PASSWORD>

---
apiVersion: v1
kind: Secret
metadata:
  name: csirevproxy-tls-secret
  namespace: powermax
type: kubernetes.io/tls
data:
  tls.crt: <BASE64_CRT>
  tls.key: <BASE64_KEY>

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: powermax-array-config
  namespace: powermax
data:
  powermax-array-config.yaml: |
    X_CSI_POWERMAX_PORTGROUPS: ""                # iSCSI only
    X_CSI_TRANSPORT_PROTOCOL: "iSCSI"            # or FC / NVMETCP
    X_CSI_POWERMAX_ENDPOINT: "https://your-unisphere.example.com:8443"
    X_CSI_MANAGED_ARRAYS: "000197800123,000197800456"

---
apiVersion: csi.dellemc.com/v1
kind: CSIPowerMax
metadata:
  name: powermax
  namespace: powermax
spec:
  csiPluginImage: quay.io/dellemc/csi-powermax:v2.14.0
  reverseProxy:
    enable: true
    tlsSecret: csirevproxy-tls-secret
    port: 2222
    serviceName: csipowermax-reverseproxy
  storage:
    protocol: iSCSI
    portGroups: ""
  unisphere:
    endpoint: "https://your-unisphere.example.com:8443"
    managedArrays: "000197800123"
  controller:
    logLevel: "info"
    volumePrefix: "pmax"
    monitorInterval: "60s"
  node:
    logLevel: "info"

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: powermax-sc
provisioner: csi-powermax.dellemc.com
parameters:
  arrayId: "000197800123"
  srp: "SRP_1"
  serviceLevel: "Diamond"
  fsType: "ext4"
reclaimPolicy: Delete
volumeBindingMode: Immediate
allowVolumeExpansion: true
```

---

# Key Points & What to Validate

* **Namespace**: Avoid conflicts.
* **Secrets**: `powermax-creds` for Unisphere, `csirevproxy-tls-secret` for TLS.
* **ConfigMap**: Ensure correct protocol, endpoint, and arrays.
* **CR (CSIPowerMax)**: Verify image, reverse proxy, storage protocol, logging, etc.
* **Health Monitor**: Optional, enable if required.
* **StorageClass**: Match provisioner name and backend parameters.
* **Topology Awareness**: Volumes may be restricted to certain nodes.
* **Node Packages**: Install `iscsi-initiator-utils`, `nvme-cli`, `multipath-tools`.
* **RBAC**: Ensure operator permissions.
* **Version Compatibility**: Check OpenShift vs PowerMax CSI support.
* **Certificates**: If not skipping validation, ensure valid certs.

---

```

Do you want me to also **make a compact version** (just key steps + critical YAML snippets) that you can use as a **quick reference guide** in your OpenShift cluster?
```
